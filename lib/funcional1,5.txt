import 'package:flutter/material.dart';

void main() {
  runApp(CalculadoraApp());
}

class CalculadoraApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Calculadora',
      theme: ThemeData(primarySwatch: Colors.blue, useMaterial3: true),
      home: CalculadoraScreen(),
    );
  }
}

class CalculadoraScreen extends StatefulWidget {
  @override
  _CalculadoraScreenState createState() => _CalculadoraScreenState();
}

class _CalculadoraScreenState extends State<CalculadoraScreen> {
  String _display = '0';
  String _expresion = '';
  bool _nuevoNumero = true;
  bool _error = false;

  // Verificar si un caracter es un operador
  bool _esOperador(String caracter) {
    return ['+', '-', '×', '÷'].contains(caracter);
  }

  // Obtener precedencia del operador
  int _precedencia(String operador) {
    if (operador == '+' || operador == '-') return 1;
    if (operador == '×' || operador == '÷') return 2;
    return 0;
  }

  // Convertir expresión infix a postfix (notación polaca inversa)
  List<String> _infixAPostfix(String expresion) {
    List<String> salida = [];
    List<String> operadores = [];

    // Separar tokens
    List<String> tokens = [];
    String numTemp = '';

    for (int i = 0; i < expresion.length; i++) {
      String char = expresion[i];

      if (RegExp(r'[0-9.]').hasMatch(char)) {
        numTemp += char;
      } else {
        if (numTemp.isNotEmpty) {
          tokens.add(numTemp);
          numTemp = '';
        }
        tokens.add(char);
      }
    }

    if (numTemp.isNotEmpty) {
      tokens.add(numTemp);
    }

    // Algoritmo Shunting-yard
    for (String token in tokens) {
      if (double.tryParse(token) != null) {
        salida.add(token);
      } else if (token == '(') {
        operadores.add(token);
      } else if (token == ')') {
        while (operadores.isNotEmpty && operadores.last != '(') {
          salida.add(operadores.removeLast());
        }
        operadores.removeLast(); // Remover '('
      } else if (_esOperador(token)) {
        while (operadores.isNotEmpty &&
            _precedencia(operadores.last) >= _precedencia(token)) {
          salida.add(operadores.removeLast());
        }
        operadores.add(token);
      }
    }

    while (operadores.isNotEmpty) {
      salida.add(operadores.removeLast());
    }

    return salida;
  }

  // Evaluar expresión postfix
  double _evaluarPostfix(List<String> postfix) {
    List<double> pila = [];

    for (String token in postfix) {
      if (double.tryParse(token) != null) {
        pila.add(double.parse(token));
      } else if (_esOperador(token)) {
        if (pila.length < 2) {
          throw Exception('Expresión inválida');
        }

        double b = pila.removeLast();
        double a = pila.removeLast();

        switch (token) {
          case '+':
            pila.add(a + b);
            break;
          case '-':
            pila.add(a - b);
            break;
          case '×':
            pila.add(a * b);
            break;
          case '÷':
            if (b == 0) {
              throw Exception('División por cero');
            }
            pila.add(a / b);
            break;
        }
      }
    }

    if (pila.length != 1) {
      throw Exception('Expresión inválida');
    }

    return pila.first;
  }

  // Calcular resultado
  void _calcular() {
    if (_expresion.isEmpty || _esOperador(_expresion[_expresion.length - 1])) {
      setState(() {
        _error = true;
        _display = 'Error: Expresión inválida';
      });
      return;
    }

    try {
      // Validar paréntesis balanceados
      int parentesisAbiertos = _expresion.split('(').length - 1;
      int parentesisCerrados = _expresion.split(')').length - 1;

      if (parentesisAbiertos != parentesisCerrados) {
        throw Exception('Paréntesis desbalanceados');
      }

      List<String> postfix = _infixAPostfix(_expresion);
      double resultado = _evaluarPostfix(postfix);

      setState(() {
        _error = false;
        _display = resultado.toString();
        if (_display.endsWith('.0')) {
          _display = _display.substring(0, _display.length - 2);
        }
        _expresion = resultado.toString();
        _nuevoNumero = true;
      });
    } catch (e) {
      setState(() {
        _error = true;
        _display = 'Error: ${e.toString().split(': ').last}';
      });
    }
  }

  // Manejar entrada de botones
  void _manejarEntrada(String entrada) {
    setState(() {
      if (_error) {
        _display = '0';
        _expresion = '';
        _error = false;
      }

      switch (entrada) {
        case 'C':
          _display = '0';
          _expresion = '';
          _nuevoNumero = true;
          break;

        case '=':
          _calcular();
          break;

        case '(':
        case ')':
          // Agregamos el paréntesis
          _expresion += entrada;
          _display = _expresion;
          // IMPORTANTE: Después de un paréntesis, el siguiente carácter
          // no debe resetear la expresión, debe concatenarse.
          _nuevoNumero = false;
          break;

        case '+':
        case '-':
        case '×':
        case '÷':
          if (_expresion.isNotEmpty &&
              !_esOperador(_expresion[_expresion.length - 1]) &&
              _expresion[_expresion.length - 1] != '(') {
            _expresion += entrada;
            _display = _expresion;
            _nuevoNumero = false;
          } else if (entrada == '-' &&
              (_expresion.isEmpty ||
                  _esOperador(_expresion[_expresion.length - 1]) ||
                  _expresion[_expresion.length - 1] == '(')) {
            _expresion += entrada;
            _display = _expresion;
            _nuevoNumero =
                false; // Corregido a false para permitir números negativos
          }
          break;

        case '.':
          if (_nuevoNumero || _expresion.isEmpty || _expresion.endsWith('(')) {
            _expresion += '0.';
            _display = _expresion;
            _nuevoNumero = false;
          } else {
            int lastOperatorIndex = -1;
            for (int i = _expresion.length - 1; i >= 0; i--) {
              if (_esOperador(_expresion[i]) ||
                  _expresion[i] == '(' ||
                  _expresion[i] == ')') {
                lastOperatorIndex = i;
                break;
              }
            }
            String currentNumber = _expresion.substring(lastOperatorIndex + 1);
            if (!currentNumber.contains('.')) {
              _expresion += entrada;
              _display = _expresion;
            }
          }
          break;

        default: // Números
          if (_nuevoNumero && _expresion.isEmpty) {
            _expresion = entrada;
            _nuevoNumero = entrada == '0';
          } else {
            // Si el último carácter es ')', opcionalmente podrías insertar un '*'
            // pero por ahora solo evitemos que se borre:
            _expresion += entrada;
            _nuevoNumero = false;
          }
          _display = _expresion;
      }
    });
  }

  // Widget de botón
  Widget _botonCalculadora(
    String texto, {
    Color? colorFondo,
    bool ampliado = false,
  }) {
    return Expanded(
      flex: ampliado ? 2 : 1,
      child: Container(
        margin: const EdgeInsets.all(4),
        child: ElevatedButton(
          onPressed: () => _manejarEntrada(texto),
          style: ElevatedButton.styleFrom(
            backgroundColor: colorFondo ?? Colors.grey[200],
            foregroundColor: Colors.black,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(8),
            ),
            padding: const EdgeInsets.all(20),
          ),
          child: Text(
            texto,
            style: const TextStyle(fontSize: 24, fontWeight: FontWeight.bold),
          ),
        ),
      ),
    );
  }

  // Widget de botón para diseño horizontal (tamaño reducido)
  Widget _botonCalculadoraHorizontal(
    String texto, {
    Color? colorFondo,
    bool ampliado = false,
  }) {
    return Expanded(
      flex: ampliado ? 2 : 1,
      child: Container(
        margin: const EdgeInsets.all(2),
        child: ElevatedButton(
          onPressed: () => _manejarEntrada(texto),
          style: ElevatedButton.styleFrom(
            backgroundColor: colorFondo ?? Colors.grey[200],
            foregroundColor: Colors.black,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(6),
            ),
            padding: const EdgeInsets.all(12),
          ),
          child: Text(
            texto,
            style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
          ),
        ),
      ),
    );
  }

  // Layout vertical (actual)
  Widget verticalLayout() {
    return Column(
      children: [
        // Display
        Container(
          padding: const EdgeInsets.all(20),
          alignment: Alignment.centerRight,
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.end,
            children: [
              Text(
                _expresion,
                style: TextStyle(fontSize: 24, color: Colors.grey[600]),
              ),
              const SizedBox(height: 10),
              Text(
                _display,
                style: TextStyle(
                  fontSize: 48,
                  fontWeight: FontWeight.bold,
                  color: _error ? Colors.red : Colors.black,
                ),
              ),
            ],
          ),
        ),

        // Teclado
        Expanded(
          child: Container(
            padding: const EdgeInsets.all(8),
            child: Column(
              children: [
                // Primera fila
                Row(
                  children: [
                    _botonCalculadora('C', colorFondo: Colors.red[100]),
                    _botonCalculadora('(', colorFondo: Colors.grey[300]),
                    _botonCalculadora(')', colorFondo: Colors.grey[300]),
                    _botonCalculadora('÷', colorFondo: Colors.orange[100]),
                  ],
                ),

                // Segunda fila
                Row(
                  children: [
                    _botonCalculadora('7'),
                    _botonCalculadora('8'),
                    _botonCalculadora('9'),
                    _botonCalculadora('×', colorFondo: Colors.orange[100]),
                  ],
                ),

                // Tercera fila
                Row(
                  children: [
                    _botonCalculadora('4'),
                    _botonCalculadora('5'),
                    _botonCalculadora('6'),
                    _botonCalculadora('-', colorFondo: Colors.orange[100]),
                  ],
                ),

                // Cuarta fila
                Row(
                  children: [
                    _botonCalculadora('1'),
                    _botonCalculadora('2'),
                    _botonCalculadora('3'),
                    _botonCalculadora('+', colorFondo: Colors.orange[100]),
                  ],
                ),

                // Quinta fila
                Row(
                  children: [
                    _botonCalculadora('0', ampliado: true),
                    _botonCalculadora('.'),
                    _botonCalculadora('=', colorFondo: Colors.green[100]),
                  ],
                ),
              ],
            ),
          ),
        ),
      ],
    );
  }

  // Layout horizontal (nuevo diseño)

  Widget horizontalLayout() {
    return Row(
      children: [
        // Display (ocupa 40% del ancho)
        Expanded(
          flex: 2,
          child: Container(
            padding: const EdgeInsets.all(20),
            alignment: Alignment.centerRight,
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              crossAxisAlignment: CrossAxisAlignment.end,
              children: [
                Text(
                  _expresion,
                  style: TextStyle(fontSize: 20, color: Colors.grey[600]),
                  overflow: TextOverflow.ellipsis,
                ),
                const SizedBox(height: 10),
                Text(
                  _display,
                  style: TextStyle(
                    fontSize: 36,
                    fontWeight: FontWeight.bold,
                    color: _error ? Colors.red : Colors.black,
                  ),
                  overflow: TextOverflow.ellipsis,
                ),
              ],
            ),
          ),
        ),

        // Teclado (ocupa 60% del ancho)
        Expanded(
          flex: 3,
          child: Container(
            padding: const EdgeInsets.all(4),
            child: Column(
              children: [
                // Primera fila: [7] [8] [9] [(] [)]
                Expanded(
                  child: Row(
                    children: [
                      _botonCalculadoraHorizontal('7'),
                      _botonCalculadoraHorizontal('8'),
                      _botonCalculadoraHorizontal('9'),
                      _botonCalculadoraHorizontal(
                        '(',
                        colorFondo: Colors.grey[300],
                      ),
                      _botonCalculadoraHorizontal(
                        ')',
                        colorFondo: Colors.grey[300],
                      ),
                    ],
                  ),
                ),

                // Segunda fila: [4] [5] [6] [*] [/]
                Expanded(
                  child: Row(
                    children: [
                      _botonCalculadoraHorizontal('4'),
                      _botonCalculadoraHorizontal('5'),
                      _botonCalculadoraHorizontal('6'),
                      _botonCalculadoraHorizontal(
                        '×',
                        colorFondo: Colors.orange[100],
                      ),
                      _botonCalculadoraHorizontal(
                        '÷',
                        colorFondo: Colors.orange[100],
                      ),
                    ],
                  ),
                ),

                // Tercera fila: [1] [2] [3] [+] [-]
                Expanded(
                  child: Row(
                    children: [
                      _botonCalculadoraHorizontal('1'),
                      _botonCalculadoraHorizontal('2'),
                      _botonCalculadoraHorizontal('3'),
                      _botonCalculadoraHorizontal(
                        '+',
                        colorFondo: Colors.orange[100],
                      ),
                      _botonCalculadoraHorizontal(
                        '-',
                        colorFondo: Colors.orange[100],
                      ),
                    ],
                  ),
                ),

                // Cuarta fila: [  0  ] [.] [c] [=]
                Expanded(
                  child: Row(
                    children: [
                      _botonCalculadoraHorizontal('0', ampliado: true),
                      _botonCalculadoraHorizontal('.'),
                      _botonCalculadoraHorizontal(
                        'C',
                        colorFondo: Colors.red[100],
                      ),
                      _botonCalculadoraHorizontal(
                        '=',
                        colorFondo: Colors.green[100],
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ),
      ],
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(title: const Text("Calculadora")),
      body: OrientationBuilder(
        builder: (context, orientation) {
          return orientation == Orientation.landscape
              ? horizontalLayout()
              : verticalLayout();
        },
      ),
    );
  }
}
